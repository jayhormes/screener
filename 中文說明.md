# 股票和加密貨幣趨勢篩選工具使用指南

## 安裝設置
需要先安裝Python3 (不限版本)

```bash
pip3 install -r requirements.txt
```
對於美股功能，需要 Polygon 和 Stocksymbol 的 API 金鑰（加密貨幣功能不需要）。將 `api_keys.json.example` 重命名為 `api_keys.json` 並填入 API 金鑰。

## 1. 加密貨幣篩選器 (Crypto Screener)

### 用途
識別當前市場中表現強勢的加密貨幣，通過計算其與多個移動平均線的相對關係來量化強度。

### 運作流程
1. 連接到加密貨幣交易所 API 獲取數據
2. 計算每個加密貨幣的移動平均線和 ATR 技術指標
3. 應用相對強度計算公式，評估價格與移動平均線的關係
4. 對結果進行排序，生成強勢標的列表
5. 輸出兼容 TradingView 的文件格式

### 關鍵參數設定
- **時間框架 (-t)**: (5m, 15m, 1h, 4h)
  
- **計算持續時間 (-d)**: 控制歷史數據量

- **程式內部參數**:
  - 相對強度公式: 考量價格與多個移動平均線之間的關係
  - ATR標準化: 確保不同價格範圍的資產可以公平比較

### 執行方法
```bash
python3 crypto_screener.py [選項]
```

選項:
- `-t, --timeframe <值>`: 時間框架 (Optional; 可選值： 5m, 15m, 30m, 1h, 2h, 4h, 8h, 1d; 默認: "15m")
- `-d, --days <值>`: 計算持續時間，單位為天 (Optional; 默認: 3)

例如:
```bash
python3 crypto_screener.py
python3 crypto_screener.py -t "1h" -d 5
```

## 2. 股票篩選器 (Stock Screener)

### 用途
識別相對於大盤強勢且符合技術趨勢條件的股票，通過篩選提供強勢選標的。

### 運作流程
1. 首先計算 SPY 指數的基準相對強度
2. 並行獲取股票歷史數據（日線和小時級別）
3. 執行成交額和趨勢條件篩選
4. 計算每個股票的相對強度得分
5. 與 SPY 相對強度比較，篩選出優於大盤的標的
6. 輸出排序結果

### 關鍵參數設定
- **每日回溯期 (_1D_OF_DAYS_TRACEBACK)**: 默認252

- **小時回溯期 (_1H_OF_DAYS_TRACEBACK)**: 默認126

- **最低成交額 (MIN_TURNOVER)**: 篩選具流動性的股票，默認10,000,000

- **Minervini 條件 (-g 選項控制)**:
  - 啟用: 應用額外的技術條件篩選（如價格與移動平均線的關係）
  - 停用: 僅依據相對強度評分，不考慮技術條件

### 執行方法
```bash
python3 stock_screener.py [選項]
```

選項:
- `-a, --all`: 在輸出中包含所有強勢標的而不僅是前980個 (Optional; 默認: 僅包含前980個，因為TradingView有導入限制)
- `-g`: 忽略 Minervini 趨勢模板條件，僅計算相對強度得分 (Optional; 默認: 應用Minervini條件)

例如:
```bash
python3 stock_screener.py 
python3 stock_screener.py -a -g
```

## 3. 相似趨勢篩選器 (Similar Trend Screener)

### 用途
基於使用者定義的參考走勢，使用動態時間規整(DTW)算法識別當前市場中發現潛在交易機會。

### 運作流程
1. 載入或獲取預定義的參考趨勢數據
2. 為每個待分析標的下載歷史數據
3. 通過DTW計算標的與參考趨勢的相似度
   - 對於比較的兩個趨勢都會先做z-score再用min/max歸一化到[-1, 1]之間
   - 先用dtaidistance dtw 快速篩選 (有C可以加速)
   - 再用shapedtw，做到更好的對齊
   - 以上都是進行價格趨勢對比，再分析移動平均線關係對比
4. 綜合計算相似度得分
5. 生成視覺化報告及TradingView觀察列表

### 關鍵參數設定

#### 命令行參數
- **-f, --file `<文件路徑>`**: 強勢標的文件路徑 (Optional; 默認: 空，使用所有可用標的)
- **--asset `<類型>`**: 資產類型 (Optional; 可選值為 'crypto' 或 'stock'; 默認: 'crypto')
- **-nv, --no_visualize**: 禁用 DTW 對齊的可視化 (Optional; 默認: 啟用可視化)
- **-k, --topk `<數值>`**: 每個參考趨勢的最匹配標的數量 (Optional; 默認: 6)
- **-s, --sleep `<秒數>`**: API 請求之間的休眠時間，單位為秒 (Optional; 默認: 0.5)

#### 程式內部參數
- **TIMEFRAMES_TO_ANALYZE**: 分析的時間框架陣列，默認 ["15m", "30m", "1h", "2h", "4h"]

- **UTC_ZONE**: 時區設置，默認 "America/Los_Angeles"
  - 修改為您所在地區的時區，例如 "Asia/Taipei" 適用於台灣

- **DTW窗口比例 (DTW_WINDOW_RATIO/DTW_WINDOW_RATIO_FOR_DIFF)**
  - 有加上FOR_DIFF就是給『移動平均線差比較』使用，沒有的話就是給『價格比較』使用 
  - 控制水平匹配範圍，默認0.2/0.1; 數值範圍: [0, 1] 
  - 增加: 允許時間軸上更彈性的匹配，可找到更多潛在匹配，設定為1就代表趨勢A的第一個點位可以跟趨勢B的最後一個點位匹配
  - 減少: 要求更嚴格的時間對齊，只找出高度相似的匹配

- **最大點距離 (DTW_MAX_POINT_DISTANCE / DTW_MAX_POINT_DISTANCE_FOR_DIFF)**
  - 控制垂直匹配限制，默認0.66/0.66，數值範圍: [0.0, 2.0]
  - 兩個趨勢都已歸一化到[-1, 1]之間，最大點距離 > |點A值 - 點B值|
  - 增加: 容許更大的價格形態偏差
  - 減少: 提高點對點匹配的嚴格度，確保形態高度相似
  - 若是最大點距離太小，可能導致演算法找不到匹配路徑

- **平衡比例 (SHAPEDTW_BALANCE_PD_RATIO)**: 默認4
  - 平衡價格距離與移動平均線差異距離的不同尺度
  - 調整此值使兩種不同尺度的測量值在計算最終得分時達到合理平衡

- **權重分配 (PRICE_WEIGHT 和 DIFF_WEIGHT)**: 默認0.4和0.6
  - 決定最終得分中價格匹配與移動平均線關係匹配的相對重要性
  - 調整比例以改變篩選器對不同類型形態的敏感度

- **參考趨勢配置 (REFERENCE_TRENDS)**:
  - 定義參考模式的起止時間和時間框架
  - 格式: `[開始日期時間, 結束日期時間, 時間框架, 標籤]`
  - 選擇理想的參考趨勢終點以優化入場時機識別
  - 可添加多個不同類型的參考趨勢模式進行匹配

- **形態描述器參數**:
  - SLOPE_WINDOW_SIZE: 控制斜率計算的窗口大小，默認5
  - PAA_WINDOW_SIZE: 影響序列數據分段聚合的粒度，默認5

### 執行方法
```bash
python3 similar_trend_screener.py [選項]
```

例如:
```bash
python3 similar_trend_screener.py
python3 similar_trend_screener.py --asset=crypto -f strong_targets.txt -k 10 -s 1.0
```

### 如何修改參考趨勢
在程式碼中修改 `REFERENCE_TRENDS` 字典來定義您想搜尋的參考模式：

```python
REFERENCE_TRENDS = {
    "AVAX": [
        [datetime(2023, 11, 9, 12, 0), datetime(2023, 11, 14, 15, 0), "1h", "standard"],
    ],
    "SOL": [
        [datetime(2023, 9, 23, 0, 0), datetime(2023, 10, 15, 21, 0), "4h", "standard"]
    ],
    # 添加您自己的參考趨勢
}
```

每個參考趨勢都需要指定：起始時間、結束時間、時間框架和標籤。建議選擇的參考走勢高低點的K棒數量要相似（會影響歸一化）還有選擇的走勢結尾應該是要上車的點位

### 相似度視覺化
腳本會生成兩種視覺化圖表:
1. 價格/SMA對齊圖: 顯示參考趨勢和目標趨勢的形態對比
2. SMA差異圖: 顯示移動平均線關係的匹配情況

這些視覺化報告能幫助分析匹配質量和理解具體的相似模式。

## 結果解讀與應用

### 加密貨幣和股票篩選結果
- 高分標的表示相對強度高，多數情況下表現優於市場平均
- 可以定期運行篩選器追蹤強度變化趨勢

### 相似趨勢匹配結果
- Distance越小越好，Score越大越好
- 高匹配分數表示當前趨勢與歷史模式高度相似
- 視覺化圖表中的連接線顯示時間軸上的具體對齊點
- 可以研究參考趨勢後續發展來評估當前標的的潛在走勢

所有篩選工具的結果文件都兼容TradingView格式，便於進一步技術分析和決策。