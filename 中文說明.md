
# 股票和加密貨幣走勢篩選工具使用指南

## 安裝設置
```bash
pip3 install -r requirements.txt
```
對於美股功能，需要 Polygon 和 Stocksymbol 的 API 金鑰（加密貨幣功能不需要）。將 `api_keys.json.example` 重命名為 `api_keys.json` 並填入 API 金鑰。

## 1. 加密貨幣篩選器 (Crypto Screener)

### 用途
識別當前市場中表現強勢的加密貨幣，通過計算其與多個移動平均線的相對關係來量化強度。

### 運作流程
1. 連接到加密貨幣交易所 API 獲取數據
2. 計算每個加密貨幣的移動平均線和 ATR 技術指標
3. 應用相對強度計算公式，評估價格與移動平均線的關係
4. 對結果進行排序，生成強勢標的列表
5. 輸出兼容 TradingView 的文件格式

### 關鍵參數設定
- **時間框架 (-t)**: (5m, 15m, 1h, 4h)
- **計算持續時間 (-d)**: 控制歷史數據量
- **程式內部參數**:
  - 相對強度公式: 考量價格與多個移動平均線之間的關係
  - ATR標準化: 確保不同價格範圍的資產可以公平比較

### 執行方法
```bash
python3 crypto_screener.py [選項]
```

選項:
- `-t, --timeframe <值>`: 時間框架 (Optional; 可選值： 5m, 15m, 30m, 1h, 2h, 4h, 8h, 1d; 默認: "15m")
- `-d, --days <值>`: 計算持續時間，單位為天 (Optional; 默認: 3)

例如:
```bash
python3 crypto_screener.py
python3 crypto_screener.py -t "1h" -d 5
```

## 2. 股票篩選器 (Stock Screener)

### 用途
識別相對於大盤強勢且符合技術走勢條件的股票，通過篩選提供強勢選標的。

### 運作流程
1. 首先計算 SPY 指數的基準相對強度
2. 並行獲取股票歷史數據（日線和小時級別）
3. 執行成交額和走勢條件篩選
4. 計算每個股票的相對強度得分
5. 與 SPY 相對強度比較，篩選出優於大盤的標的
6. 輸出排序結果

### 關鍵參數設定
- **每日回溯期 (_1D_OF_DAYS_TRACEBACK)**: 默認252
- **小時回溯期 (_1H_OF_DAYS_TRACEBACK)**: 默認126
- **最低成交額 (MIN_TURNOVER)**: 篩選具流動性的股票，默認10,000,000
- **Minervini 條件 (-g 選項控制)**:
  - 啟用: 應用額外的技術條件篩選（如價格與移動平均線的關係）
  - 停用: 僅依據相對強度評分，不考慮技術條件

### 執行方法
```bash
python3 stock_screener.py [選項]
```

選項:
- `-a, --all`: 在輸出中包含所有強勢標的而不僅是前980個 (Optional; 默認: 僅包含前980個，因為TradingView有導入限制)
- `-g`: 忽略 Minervini 走勢模板條件，僅計算相對強度得分 (Optional; 默認: 應用Minervini條件)

例如:
```bash
python3 stock_screener.py 
python3 stock_screener.py -a -g
```

## 3. 加密貨幣走勢篩選器 (Crypto Trend Screener)

### 用途
基於使用者定義的參考走勢，使用動態時間規整(DTW)算法識別當前市場中發現潛在交易機會。

### 運作流程
1. 載入或獲取預定義的參考走勢數據
2. 為每個待分析標的下載歷史數據
3. 通過DTW計算標的與參考走勢的相似度
   - 先用dtaidistance dtw 快速篩選 (有C可以加速)
   - 再用shapedtw，做到更好的對齊
   - 以上都是進行價格走勢對比，再分析移動平均線關係對比
4. 綜合計算相似度得分
5. 生成視覺化報告及TradingView觀察列表

### 關鍵參數設定
- **-f, --file `<文件路徑>`**: 強勢標的文件路徑 (Optional; 默認: 空，使用所有可用標的)
- **--asset `<類型>`**: 資產類型 (Optional; 可選值為 'crypto' 或 'stock'; 默認: 'crypto')
- **-nv, --no_visualize**: 禁用 DTW 對齊的可視化 (Optional; 默認: 啟用可視化)
- **-k, --topk `<數值>`**: 每個參考走勢記錄的最匹配標的數量 (Optional; 默認: 6)
- **-s, --sleep `<秒數>`**: API 請求之間的休眠時間，單位為秒 (Optional; 默認: 0.5)
- **TIMEFRAMES_TO_ANALYZE**: 分析的時間框架陣列，默認 ["15m", "30m", "1h", "2h", "4h"]
- **TIMEZONE**: 時區設置，默認 "America/Los_Angeles"，可修改為您所在地區如 "Asia/Taipei"
- **DTW_WINDOW_RATIO**: 控制水平匹配範圍，默認0.2
- **DTW_MAX_POINT_DISTANCE**: 控制垂直匹配限制，默認0.66
- **PRICE_WEIGHT 和 DIFF_WEIGHT**: 價格與移動平均線關係匹配的權重分配，默認0.4和0.6
- **REFERENCE_TRENDS**: 參考走勢配置，格式為 `[開始日期時間, 結束日期時間, 時間框架, 標籤]`

### 執行方法
```bash
python3 crypto_trend_screener.py [選項]
```

例如:
```bash
python3 crypto_trend_screener.py
python3 crypto_trend_screener.py --asset=crypto -f strong_targets.txt -k 10 -s 1.0
```

### 如何修改參考走勢
在程式碼中修改 `REFERENCE_TRENDS` 字典來定義您想搜尋的參考走勢：

```python
REFERENCE_TRENDS = {
    "AVAX": [
        [datetime(2023, 11, 9, 12, 0), datetime(2023, 11, 14, 15, 0), "1h", "standard"],
    ],
    "SOL": [
        [datetime(2023, 9, 23, 0, 0), datetime(2023, 10, 15, 21, 0), "4h", "standard"]
    ],
    # 添加您自己的參考走勢
}
```

### 相似度視覺化
腳本會生成兩種視覺化圖表:
1. 價格/SMA對齊圖: 顯示參考走勢和目標走勢的形態對比
2. SMA差異圖: 顯示移動平均線關係的匹配情況

## 4. 歷史相似走勢分析器 (Crypto Historical Trend Finder)

### 用途
搜尋歷史數據中與參考走勢相似的走勢，並分析這些走勢的後續價格走向，提供統計性預測參考。

### 運作流程
1. 在多個時間框架(15m, 30m, 1h, 2h, 4h)搜尋歷史相似走勢
2. 使用DTW算法進行走勢匹配
3. 分析每個匹配走勢的後續價格走向
4. 計算統計數據（如上漲/下跌比例）
5. 生成包含過去、走勢、未來的完整視覺化報告

### 關鍵參數設定
- `-k, --topk <數值>`: 保留的最佳匹配數量 (Optional; 默認: 300)
- `-s, --sleep <秒數>`: API 請求間隔時間，單位為秒 (Optional; 默認: 15)
- **TOP_K**: 保留的最佳匹配數量，默認300
- **API_SLEEP_SECONDS**: API請求間隔時間，默認15秒
- **EXTENSION_FACTORS_FOR_STATS**: 延伸係數統計範圍，默認[0.25, 0.5, 0.75, 1.0, 1.5, 2.0, 2.5]
- **VIS_EXTENSION_FUTURE_LENGTH_FACTOR**: 未來視覺化延伸係數，默認2.0
- **REFERENCE_TRENDS**: 參考走勢配置，格式為 `[開始日期時間, 結束日期時間, 時間框架, 標籤]`，建議選擇的參考走勢高低點的K棒數量要相似，走勢結尾應該是理想的進場點位
- **GLOBAL_OVERLAP_FILTERING**: 重疊過濾策略，默認True
  - **True (全域過濾)**: 在所有標的和時間框架中確保沒有任何時間重疊的走勢。如果發現兩個相似走勢在時間上有重疊（即使來自不同標的），只保留相似度最高的那個。這確保每個時間段只有一個最佳匹配走勢，適合需要高品質、無重複的分析樣本。
  - **False (個別標的過濾)**: 只在同一標的內避免時間重疊，允許不同標的在相同時間段都有匹配走勢。例如BTC和ETH可以在同一時間段都被識別為相似走勢。這會產生更多的分析樣本，但可能包含市場整體走勢的影響。
- **TIMEZONE**: 時區設置，默認 "America/Los_Angeles"，影響日期時間顯示和參考走勢時間解析
- **HISTORICAL_START_DATE**: 歷史數據起始日期，默認datetime(2021, 1, 1)
- **TIMEFRAMES_TO_ANALYZE**: 分析的時間框架，默認["15m", "30m", "1h", "2h", "4h"]

### 上漲/下跌認定與統計分析說明

#### 走勢方向判定機制
系統使用兩種不同的延伸係數來進行分析：

1. **視覺化標記用** - **VIS_EXTENSION_FUTURE_LENGTH_FACTOR** (默認2.0)
   - 用於判定每個找到的歷史走勢是「上漲」或「下跌」
   - 決定視覺化圖表中檔案名稱的標記（如 `_rise.png`、`_fall.png`）
   - 計算方式：走勢長度 × 2.0 = 觀察的未來期間
   - 例如：30根K棒的走勢 × 2.0 = 觀察未來60根K棒
   - 比較走勢結束時收盤價 vs 觀察期間結束時收盤價來判定漲跌

2. **統計分析用** - **EXTENSION_FACTORS_FOR_STATS** [0.25, 0.5, 0.75, 1.0, 1.5, 2.0, 2.5]
   - 用於生成多維度統計報告
   - 提供不同時間長度的預測成功率分析
   - 與視覺化標記獨立運作

#### 統計分析目的與方法
程式對所有找到的歷史相似走勢進行統計分析，目的是回答「如果現在出現類似的走勢，未來價格走向的機率是多少？」

**多時間範圍統計**：
- **短期預測** (0.25x): 觀察走勢長度1/4的未來期間
- **中期預測** (1.0x): 觀察與走勢等長的未來期間  
- **長期預測** (2.5x): 觀察走勢長度2.5倍的未來期間

**統計指標計算**：
對每個延伸係數分別計算：
- **上漲比例**: 未來價格上漲的走勢數量 / 總有效走勢數量
- **下跌比例**: 未來價格下跌的走勢數量 / 總有效走勢數量
- **數據不足比例**: 未來數據不充分的走勢比例
- **無數據比例**: 完全沒有未來數據的走勢比例

**統計報告範例**：
```
Extension Factor Analysis:
  0.25x: Rise 198(43.5%) | Fall 254(55.8%) | Insufficient 3(0.7%)
  0.5x: Rise 191(42.0%) | Fall 259(56.9%) | Insufficient 5(1.1%)
  0.75x: Rise 186(40.9%) | Fall 260(57.1%) | Insufficient 9(2.0%)
  1.0x: Rise 169(37.1%) | Fall 275(60.4%) | Insufficient 11(2.4%)
  1.5x: Rise 166(36.5%) | Fall 268(58.9%) | Insufficient 21(4.6%)
  2.0x: Rise 159(34.9%) | Fall 267(58.7%) | Insufficient 29(6.4%)
  2.5x: Rise 167(36.7%) | Fall 250(54.9%) | Insufficient 38(8.4%)
```

**特殊情況處理**：
- **insufficient_data**: 未來數據不足指定觀察期間，但仍有部分數據可分析
- **no_future_data**: 走勢結束後完全沒有未來數據可供分析

### 執行方法
```bash
python3 crypto_historical_trend_finder.py [選項]
```

例如:
```bash
python3 crypto_historical_trend_finder.py
python3 crypto_historical_trend_finder.py -k 500 -s 10
```

### 輸出報告
- **整體統計摘要**: 所有時間框架的綜合統計
- **時間框架分析**: 各時間框架的詳細結果  
- **三段式視覺化**: 過去+走勢+未來的完整分析圖表
- **走勢統計**: 例如「75%的相似走勢在2倍走勢長度內出現上漲」

## 結果解讀與應用

### 加密貨幣和股票篩選結果
- 高分標的表示相對強度高，多數情況下表現優於市場平均
- 可以定期運行篩選器追蹤強度變化走勢

### 相似走勢匹配結果
- Distance越小越好，Score越大越好
- 高匹配分數表示當前走勢與歷史走勢高度相似
- 視覺化圖表中的連接線顯示時間軸上的具體對齊點
- 可以研究參考走勢後續發展來評估當前標的的潛在走勢

### 歷史走勢分析結果
- 統計報告顯示相似走勢的歷史表現，如「漲跌比例」
- 可以根據統計結果評估當前相似走勢的潛在走勢
- 不同延伸係數提供短期和長期的預測參考
- 數據充足性指標幫助評估預測的可靠程度

所有篩選工具的結果文件都兼容TradingView格式，便於進一步技術分析和決策。
